"use strict";(()=>{var e={};e.id=289,e.ids=[289],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8678:e=>{e.exports=import("pg")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},9050:(e,t,a)=>{a.r(t),a.d(t,{config:()=>d,default:()=>l,routeModule:()=>h});var s={};a.r(s),a.d(s,{default:()=>p});var n=a(1802),r=a(7153),c=a(6249);async function o(e,t,a){let s=[];if(a.market_cap&&(a.market_cap>2e11?s.push("超大盘股"):a.market_cap>5e10?s.push("大盘股"):a.market_cap>1e10?s.push("中盘股"):a.market_cap>2e9?s.push("小盘股"):s.push("微盘股")),null!==a.change_percent&&void 0!==a.change_percent&&(a.change_percent>10?s.push("涨停板"):a.change_percent>5?s.push("强势上涨"):a.change_percent>2?s.push("温和上涨"):a.change_percent>0?s.push("微涨"):a.change_percent<-10?s.push("跌停板"):a.change_percent<-5?s.push("大幅下跌"):a.change_percent<-2?s.push("温和下跌"):a.change_percent<0?s.push("微跌"):s.push("平盘")),a.last_price&&(a.last_price>1e3?s.push("高价股"):a.last_price>100?s.push("中价股"):a.last_price>10?s.push("低价股"):s.push("超低价股")),a.volume&&(a.volume>1e8?s.push("超高成交量"):a.volume>5e7?s.push("高成交量"):a.volume>1e7?s.push("中等成交量"):a.volume<1e6&&s.push("低成交量")),a.sector_zh){let e=a.sector_zh;(e.includes("科技")||e.includes("信息技术"))&&s.push("科技股"),(e.includes("医疗")||e.includes("生物"))&&s.push("医药股"),(e.includes("金融")||e.includes("银行"))&&s.push("金融股"),(e.includes("能源")||e.includes("石油"))&&s.push("能源股"),(e.includes("消费")||e.includes("零售"))&&s.push("消费股")}return s}async function u(e,t,a){let s=0;for(let n of a)try{await e.query("INSERT INTO tags (name, type) VALUES ($1, 'dynamic') ON CONFLICT (name) DO NOTHING",[n]),(await e.query(`INSERT INTO stock_tags (stock_ticker, tag_id) 
                 SELECT $1, id FROM tags WHERE name = $2 
                 ON CONFLICT (stock_ticker, tag_id) DO NOTHING
                 RETURNING *`,[t,n])).rowCount>0&&s++}catch(e){console.warn(`Failed to apply tag ${n} to ${t}:`,e.message)}return s}async function i(e,t){try{return(await e.query(`DELETE FROM stock_tags 
             WHERE stock_ticker = $1 
             AND tag_id IN (SELECT id FROM tags WHERE type = 'dynamic')`,[t])).rowCount}catch(e){return console.warn(`Failed to cleanup old tags for ${t}:`,e.message),0}}async function p(e,t){if(e.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return t.status(401).json({error:"Unauthorized"});let{Pool:s}=await Promise.resolve().then(a.bind(a,8678)),n=new s({connectionString:process.env.NEON_DATABASE_URL,ssl:{rejectUnauthorized:!1}}),r=await n.connect();console.log("===== Starting dynamic tags update job =====");try{await r.query("BEGIN");let{rows:e}=await r.query(`SELECT ticker, name_zh, sector_zh, market_cap, last_price, 
                    change_amount, change_percent, volume, last_updated
             FROM stocks 
             WHERE last_price IS NOT NULL 
             ORDER BY market_cap DESC NULLS LAST
             LIMIT 200`);console.log(`Found ${e.length} stocks with data to process`);let a=0,s=0,n=0;for(let t of e)try{let e=await i(r,t.ticker);n+=e;let c=await o(r,t.ticker,t),p=await u(r,t.ticker,c);s+=p,c.length>0&&console.log(`${t.ticker} (${t.name_zh}): Applied ${p} tags - ${c.join(", ")}`),++a%10==0&&await new Promise(e=>setTimeout(e,50))}catch(e){console.warn(`Failed to process tags for ${t.ticker}:`,e.message)}await r.query("COMMIT");let c=`Tags update completed. Processed ${a} stocks, removed ${n} old tags, applied ${s} new tags.`;console.log(c),t.status(200).json({success:!0,message:c,stats:{processedStocks:a,totalStocks:e.length,tagsRemoved:n,tagsApplied:s}})}catch(e){await r.query("ROLLBACK"),console.error("!!!!! Tags update job FAILED !!!!!",e),t.status(500).json({success:!1,error:e.message})}finally{r.release()}}let l=(0,c.l)(s,"default"),d=(0,c.l)(s,"config"),h=new n.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/update-tags",pathname:"/api/update-tags",bundlePath:"",filename:""},userland:s})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=9050);module.exports=a})();