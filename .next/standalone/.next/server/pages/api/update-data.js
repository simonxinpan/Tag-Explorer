"use strict";(()=>{var e={};e.id=526,e.ids=[526],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8678:e=>{e.exports=import("pg")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},2871:(e,t,a)=>{a.r(t),a.d(t,{config:()=>d,default:()=>p,routeModule:()=>g});var o={};a.r(o),a.d(o,{default:()=>u});var n=a(1802),s=a(7153),r=a(6249);async function i(e){let t=new Date;for(let a=0;a<7;a++){let a=t.toISOString().split("T")[0],o=`https://api.polygon.io/v2/aggs/grouped/locale/us/market/stocks/${a}?adjusted=true&apiKey=${e}`;try{console.log(`[Polygon] Attempting snapshot for ${a}...`);let e=await fetch(o,{signal:AbortSignal.timeout(15e3)});if(e.ok){let t=await e.json();if(t&&t.resultsCount>0){let e=new Map;return t.results.forEach(t=>e.set(t.T,t)),console.log(`[Polygon] Successfully fetched ${t.resultsCount} quotes for ${a}`),e}}else console.warn(`[Polygon] API for ${a} returned status: ${e.status}`)}catch(e){console.error(`[Polygon] Fetch failed for ${a}:`,e.message)}t.setDate(t.getDate()-1)}throw Error("Could not fetch any snapshot data from Polygon after 7 attempts.")}async function c(e,t){try{let a=`https://finnhub.io/api/v1/stock/metric?symbol=${e}&metric=all&token=${t}`,o=await fetch(a,{signal:AbortSignal.timeout(1e4)});if(o.ok)return(await o.json()).metric||{}}catch(t){console.warn(`[Finnhub] Failed to fetch metrics for ${e}:`,t.message)}return{}}async function l(e,t,a,o){let n=[];for(let s of(a.marketCap&&(a.marketCap>2e11?n.push("大盘股"):a.marketCap>1e10?n.push("中盘股"):n.push("小盘股")),void 0!==a.changePercent&&(a.changePercent>5?n.push("强势上涨"):a.changePercent>2?n.push("温和上涨"):a.changePercent<-5?n.push("大幅下跌"):a.changePercent<-2?n.push("温和下跌"):n.push("横盘整理")),a.volume&&(a.volume>5e7?n.push("高成交量"):a.volume<1e6&&n.push("低成交量")),o.peNormalizedAnnual&&(o.peNormalizedAnnual>30?n.push("高估值"):o.peNormalizedAnnual<15&&n.push("低估值")),o.dividendYieldIndicatedAnnual>3&&n.push("高股息"),n))try{await e.query("INSERT INTO tags (name, type) VALUES ($1, 'dynamic') ON CONFLICT (name) DO NOTHING",[s]),await e.query(`INSERT INTO stock_tags (stock_ticker, tag_id) 
                 SELECT $1, id FROM tags WHERE name = $2 
                 ON CONFLICT (stock_ticker, tag_id) DO NOTHING`,[t,s])}catch(e){console.warn(`Failed to apply tag ${s} to ${t}:`,e.message)}return n}async function u(e,t){if(e.headers.authorization!==`Bearer ${process.env.CRON_SECRET}`)return t.status(401).json({error:"Unauthorized"});let{Pool:o}=await Promise.resolve().then(a.bind(a,8678)),n=new o({connectionString:process.env.NEON_DATABASE_URL,ssl:{rejectUnauthorized:!1}}),s=await n.connect();console.log("===== Starting daily data injection & tag update job =====");try{await s.query("BEGIN");let{rows:e}=await s.query("SELECT ticker FROM stocks LIMIT 100");console.log(`Step 1: Found ${e.length} companies in DB.`),console.log("Step 2: Fetching data from Polygon and Finnhub...");let a=await i(process.env.POLYGON_API_KEY),o=0,n=0;for(let t of e){let e=t.ticker;try{let t=a.get(e);if(t){await s.query(`UPDATE stocks SET 
                         last_price = $1, 
                         change_amount = $2, 
                         change_percent = $3, 
                         volume = $4,
                         market_cap = $5,
                         last_updated = NOW()
                         WHERE ticker = $6`,[t.c,t.c-t.o,(t.c-t.o)/t.o*100,t.v,1e6*t.c,e]),o++;let a=await c(e,process.env.FINNHUB_API_KEY),r={marketCap:1e6*t.c,changePercent:(t.c-t.o)/t.o*100,volume:t.v},i=await l(s,e,r,a);i.length>0&&(n++,console.log(`Applied tags to ${e}: ${i.join(", ")}`)),await new Promise(e=>setTimeout(e,100))}}catch(t){console.warn(`Failed to process ${e}:`,t.message)}}await s.query("COMMIT");let r=`Data update completed. Updated ${o} stocks, applied tags to ${n} stocks.`;console.log(r),t.status(200).json({success:!0,message:r,stats:{totalCompanies:e.length,updatedStocks:o,taggedStocks:n}})}catch(e){await s.query("ROLLBACK"),console.error("!!!!! Job FAILED !!!!!",e),t.status(500).json({success:!1,error:e.message})}finally{s.release()}}let p=(0,r.l)(o,"default"),d=(0,r.l)(o,"config"),g=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/update-data",pathname:"/api/update-data",bundlePath:"",filename:""},userland:o})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=2871);module.exports=a})();